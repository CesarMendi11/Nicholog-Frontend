<div class="dashboard-container">
  <div class="header">
    <div>
      <h1>Resumen Financiero</h1>
      <p>Estado actual de tu colección</p>
    </div>
    <button mat-stroked-button (click)="exportReport()">
      <mat-icon>download</mat-icon>
      Reporte CSV
    </button>
  </div>

  <!-- SKELETON LOADER (Carga Premium) -->
  <div class="loading-container" *ngIf="!(stats$ | async)">
    <div class="skeleton-grid">
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
      <div class="skeleton-card"></div>
    </div>
  </div>

  <div class="widgets-grid" *ngIf="stats$ | async as stats">

    <!-- Cost Card (Clicable) -->
    <mat-card class="widget-card cost-card" [routerLink]="['/dashboard/analytics/costo']">
      <mat-card-content>
        <div class="widget-icon"><mat-icon>shopping_cart</mat-icon></div>
        <div class="widget-data">
          <span class="label">Costo Total</span>
          <span class="value">{{ stats.totalCost | currency }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Value Card (Clicable) -->
    <mat-card class="widget-card value-card" [routerLink]="['/dashboard/analytics/valor']">
      <mat-card-content>
        <div class="widget-icon"><mat-icon>trending_up</mat-icon></div>
        <div class="widget-data">
          <span class="label">Valor Estimado</span>
          <span class="value">{{ stats.totalValue | currency }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ROI Card (No clicable, informativo) -->
    <mat-card class="widget-card roi-card" [class.negative]="roiValue < 0">
      <mat-card-content>
        <div class="widget-icon">
          <mat-icon>{{ roiValue >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
        </div>
        <div class="widget-data">
          <span class="label">Rentabilidad</span>
          <span class="value" [class.profit]="roiValue >= 0" [class.loss]="roiValue < 0">
            {{ roiValue | currency }} <small>({{ roiValue >= 0 ? '+' : '' }}{{ roiPercentage | number:'1.0-1' }}%)</small>
          </span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Count Card (Clicable) -->
    <mat-card class="widget-card count-card" [routerLink]="['/dashboard/analytics/items']">
      <mat-card-content>
        <div class="widget-icon"><mat-icon>inventory_2</mat-icon></div>
        <div class="widget-data">
          <span class="label">Total Artículos</span>
          <span class="value">{{ stats.itemCount }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- NUEVO: Gráfico Histórico de Valor (Línea de Tiempo) -->
    <mat-card class="widget-card history-card">
      <mat-card-header>
        <mat-card-title>Evolución del Valor</mat-card-title>
        <mat-card-subtitle>Proyección de crecimiento anual</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="line-chart-container">
          <svg viewBox="0 0 300 120" class="line-chart">
            <defs>
              <linearGradient id="lineGradient" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#3f51b5" stop-opacity="0.2"/>
                <stop offset="100%" stop-color="#3f51b5" stop-opacity="0"/>
              </linearGradient>
            </defs>
            
            <!-- Línea Guía Base -->
            <line x1="0" y1="100" x2="300" y2="100" stroke="#eee" stroke-width="1" />

            <!-- Área sombreada con gradiente -->
            <path [attr.d]="chartAreaPath" [attr.fill]="'url(#lineGradient)'" class="chart-area" />
            
            <!-- La Línea del Gráfico -->
            <polyline [attr.points]="chartPoints" fill="none" stroke="#3f51b5" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="chart-line" />
            
            <!-- Etiquetas de Meses -->
            <text *ngFor="let d of historyData; let i = index" [attr.x]="(i / (historyData.length - 1)) * 300" y="115" font-size="10" text-anchor="middle" fill="#999">{{ d.month }}</text> 
          </svg>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Chart Card -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Distribución de Inversión</mat-card-title>
      </mat-card-header>
      <mat-card-content class="chart-content">
        <div class="pie-chart" [style.background]="pieChartStyle$ | async"></div>
        <div class="legend">
          <div *ngFor="let cat of stats.categoryDistribution" class="legend-item">
            <span class="color-dot" [style.background-color]="cat.color"></span>
            <span class="cat-name">{{ cat.label }}</span>
            <span class="cat-value">{{ cat.percentage }}%</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Top Items Card -->
    <mat-card class="chart-card top-items-card">
      <mat-card-header>
        <mat-card-title>Joyas de la Colección</mat-card-title>
        <mat-card-subtitle>Tus 5 artículos más valiosos</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="top-items-list">
          <div *ngFor="let item of stats.topItems" class="top-item-row">
            <img [src]="item.image || 'https://placehold.co/50?text=IMG'" class="item-thumb" onerror="this.src='https://placehold.co/50?text=IMG'">
            <div class="item-info">
              <span class="item-name">{{ item.name }}</span>
              <span class="item-collection">{{ item.collectionName }}</span>
            </div>
            <span class="item-value">{{ item.value | currency }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- NUEVO: Feed de Actividad Reciente -->
    <mat-card class="chart-card activity-card">
      <mat-card-header>
        <mat-card-title>Actividad Reciente</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="activity-list">
          <div *ngFor="let act of recentActivity" class="activity-item">
            <div class="activity-icon" [style.background-color]="act.color + '20'" [style.color]="act.color">
              <mat-icon>{{ act.icon }}</mat-icon>
            </div>
            <div class="activity-details">
              <span class="act-text"><strong>{{ act.action }}</strong> {{ act.item }}</span>
              <span class="act-time">{{ act.time }}</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>
